# Iteration 2 - Cross-Audit #3: Unaccounted Memory Leak

## –î–∞—Ç–∞
2025-10-01

## –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–≤—Å–µ–≥–æ 9):
- H2.2, H2.3, H2.4, H2.6
- C2.1, C2.3, C2.5
- C3.3, C3.6

### Cross-Audit #2 findings:
**Tracked sources = 0.54 MB, Actual growth = 30 MB**

**–û–≥—Ä–æ–º–Ω–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: 29.46 MB –Ω–µ—É—á—Ç–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞!

---

## Deep Dive: Missing 30 MB

### –ß—Ç–æ –º—ã –ø—Ä–æ–≤–µ—Ä–∏–ª–∏:
‚úÖ candles_buffer - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (H2.1 INVALID)
‚úÖ _seen_trade_signatures - 0.18 MB (C3.1 INVALID)
‚úÖ _trades_by_interval - 0.04 MB (C3.2 INVALID)
‚úÖ _candle_log_queue - 0.32 MB (C3.3 VALID but small)

**–ò—Ç–æ–≥–æ tracked**: 0.54 MB
**Actual growth**: 30 MB
**Missing**: 29.46 MB (98% –Ω–µ—É—á—Ç–µ–Ω–æ!)

---

## –ù–æ–≤—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã

### üî¥ C4.1 - Python Objects Overhead
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –≤ Python –∏–º–µ–µ—Ç –±–æ–ª—å—à–æ–π overhead

**–ê–Ω–∞–ª–∏–∑**:
```python
# –ö–∞–∂–¥–∞—è —Å–≤–µ—á–∞ - —ç—Ç–æ dict:
candle = {
    'timestamp': 1234567890,
    'open': 0.1234,
    'high': 0.1235,
    'low': 0.1233,
    'close': 0.1234,
    'volume': 1000.0
}
```

**–†–∞–∑–º–µ—Ä –≤ –ø–∞–º—è—Ç–∏**:
- Dict overhead: ~240 bytes
- 6 key-value pairs * ~50 bytes = ~300 bytes
- **–ò—Ç–æ–≥–æ: ~540 bytes –Ω–∞ —Å–≤–µ—á—É**

–ù–æ –º—ã —Å—á–∏—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω—É —Å–ø–∏—Å–∫–∞:
- 59 –º–æ–Ω–µ—Ç * 11 —Å–≤–µ—á–µ–π * 540 bytes = 350 KB (0.35 MB)

**–≠—Ç–æ –ù–ï –æ–±—ä—è—Å–Ω—è–µ—Ç 30 MB!**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚ö†Ô∏è –í–ê–ñ–ù–û
**–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ù—É–∂–µ–Ω memory profiler

---

### üî¥ C4.2 - Logs Files Growth (–Ω–µ –≤ RAM, –Ω–æ –Ω–∞ –¥–∏—Å–∫–µ)
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: –õ–æ–≥–∏ —Ä–∞—Å—Ç—É—Ç –Ω–∞ –¥–∏—Å–∫–µ, –Ω–æ –º—ã –º–µ—Ä—è–µ–º RSS

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
- –ú—ã –º–µ—Ä—è–µ–º `process.memory_info().rss` = Resident Set Size (RAM)
- –§–∞–π–ª—ã logs/*.json –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–ª–∏—è—Ç—å –Ω–∞ RSS

**–í—ã–≤–æ–¥**: –ú–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚úÖ –ù–ò–ó–ö–ò–ô

---

### üî¥ C4.3 - WebSocket Messages in Memory
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: websockets –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–ê–Ω–∞–ª–∏–∑**:
- 20 WebSocket connections (59 coins / 3 per connection)
- –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç —Ç—Ä–µ–π–¥—ã –≤ real-time
- –ï—Å–ª–∏ receive buffer –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è ‚Üí –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ

**–†–∞—Å—á–µ—Ç** (–≥—Ä—É–±—ã–π):
- ~100 —Ç—Ä–µ–π–¥–æ–≤/s –Ω–∞ 59 –º–æ–Ω–µ—Ç = ~170 —Ç—Ä–µ–π–¥–æ–≤/s
- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ~200 bytes
- 120s * 170 * 200 bytes = 4 MB

**–≠—Ç–æ —Ç–æ–∂–µ –º–∞–ª–æ –¥–ª—è 30 MB!**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚ö†Ô∏è –í–ê–ñ–ù–û

---

### üî¥ C4.4 - Multiple TradeWebSocket Instances
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ aggregator

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞** (test_01_buffer_memory_short.py:43-44):
```python
filtered_coins = get_all_symbols_by_volume()
aggregator = TradeWebSocket(filtered_coins)
```

**–ù–æ** –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —ç—Ç–æ –í –¢–ï–°–¢–ï, –∞ –Ω–µ –≤ main().

–ú–æ–∂–µ—Ç –±—ã—Ç—å:
1. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–µ—Ç aggregator
2. main() —Ç–æ–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ?
3. –î–≤–∞ aggregator ‚Üí –¥–≤–æ–π–Ω–∞—è –ø–∞–º—è—Ç—å!

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ù–û
**–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã

---

### üî¥ C4.5 - JSON Encoding in Log Queue
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: –õ–æ–≥–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ JSON –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏

**–ê–Ω–∞–ª–∏–∑** (config.py:314-326):
```python
# –í worker –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
for coin, candle_data in batch:
    # Console log
    logger.info(f"...")

    # File log
    log_record = type('obj', (object,), {
        'levelname': 'INFO',
        'getMessage': lambda self: f"Candle for {coin}",
        'coin': coin,
        'candle_data': candle_data  # Dict stored here!
    })()
    file_handler.emit(log_record)
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- candle_data —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ log_record
- log_record —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ queue (C3.3 –ø–æ–∫–∞–∑–∞–ª 661 items)
- 661 —Å–≤–µ—á–µ–π * 540 bytes = 0.36 MB

**–û–ø—è—Ç—å –º–∞–ª–æ!**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚ö†Ô∏è –í–ê–ñ–ù–û

---

### üî¥ C4.6 - Imports Cache / Module Caching
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: Python –∫–µ—à–∏—Ä—É–µ—Ç –º–æ–¥—É–ª–∏ –∏ –∏—Ö –¥–∞–Ω–Ω—ã–µ

**–ê–Ω–∞–ª–∏–∑**:
–ö–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º `from src.config import log_new_candle` - –º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å.

**–ù–æ** Python –∫–µ—à–∏—Ä—É–µ—Ç –º–æ–¥—É–ª–∏ –≤ `sys.modules`, –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏–∏.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚úÖ –ù–ò–ó–ö–ò–ô

---

## –ì–ª–∞–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞

### üî¥üî¥üî¥ C4.7 - Console Logging Unicode Encoding
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: Console logging —Å unicode —Å–∏–º–≤–æ–ª–∞–º–∏ —Å–æ–∑–¥–∞–µ—Ç –±–æ–ª—å—à–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø–∞–º—è—Ç–∏

**–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤**:
```
2025-10-01 06:29:50 - INFO - üìä ‚ùå NO SIGNAL for ONDOUSDT | Candles: 211 | Passed: [growth_filter(-0.08)] | Failed: [low_vol(4913.0 vs 0.0), narrow_rng(0.0001 vs 0.0), high_natr(0.017 vs 0.6)]
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. Emoji (üìä ‚ùå) - –∫–∞–∂–¥—ã–π ~4 bytes –≤ UTF-8
2. –î–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (>200 —Å–∏–º–≤–æ–ª–æ–≤)
3. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å–∏–≥–Ω–∞–ª–∞: 59 –º–æ–Ω–µ—Ç * 20 —Ä–∞–∑/–º–∏–Ω—É—Ç—É = 1180 –ª–æ–≥–æ–≤/–º–∏–Ω—É—Ç—É
4. Python logging –¥–µ—Ä–∂–∏—Ç recent logs –≤ –ø–∞–º—è—Ç–∏!

**–†–∞—Å—á–µ—Ç**:
- 1180 –ª–æ–≥–æ–≤/–º–∏–Ω * 200 bytes/log * 2 minutes = 472 KB

**–û–ø—è—Ç—å –º–∞–ª–æ!**

**–ù–û** –µ—Å–ª–∏ —É—á–µ—Å—Ç—å, —á—Ç–æ logging.StreamHandler –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç:
- Handler –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ª–æ–≥–æ–≤
- logging module —Å–∞–º –∏–º–µ–µ—Ç memory overhead

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚ö†Ô∏è –í–ê–ñ–ù–û

---

## –ü–ª–∞–Ω –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Cross-Audit #3

1. **C4.4** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ aggregator
2. **C4.1** - Memory profiler –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞
3. **C4.7** - –û—Ç–∫–ª—é—á–∏—Ç—å console logging –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–º—è—Ç—å
4. **C4.3** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket buffers
5. **C4.5** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JSON encoding overhead

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ

**–ò–∑ test_01 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**:
```
[270s] Memory: 69.16MB (+32.67MB, +89.5%)
[301s] Memory: 34.98MB (+-1.52MB, +-4.2%)  # –†–ï–ó–ö–ò–ô –°–ü–ê–î!
```

**–ü–∞–º—è—Ç—å –£–ü–ê–õ–ê —Å 69 MB –¥–æ 35 MB –º–µ–∂–¥—É 270s –∏ 301s!**

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
1. Garbage Collector —Å—Ä–∞–±–æ—Ç–∞–ª
2. –ò–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è
3. –ò–ª–∏ memory measurement –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

**–ù–æ–≤–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ C4.8**: Memory measurement –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ù–û

---

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**:
- C4.4 (Multiple instances)
- C4.8 (Measurement error)

**–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**:
- C4.1 (Python overhead)
- C4.7 (Console logging)

**–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**:
- C4.3, C4.5, C4.6 (–º–∞–ª—ã–µ –≤–∫–ª–∞–¥—ã)

**–¶–µ–ª—å**: –ù–∞–π—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ 30 MB leak –ò–õ–ò –¥–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ measurement –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
